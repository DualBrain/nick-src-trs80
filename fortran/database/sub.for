C234567890
      SUBROUTINE SETUP
      INTEGER ERRCOD,LSTART,STRING
      COMMON ERRCOD,LSTART
      ERRCOD=0
      CALL INSDSK(0)
      CALL OPEN(6,'TREEFILE ',24)
      CALL OPEN(7,'DISKFREE ',6)
      CALL OPEN(8,'COMMENTS ',33)
      CALL OPEN(9,'DELETED  ',6)
      CALL OPEN(10,'WHERE   ',11)
      READ (6,10,REC=1) STRING
   10 FORMAT (A1)
      READ(7,10,REC=1) STRING
      READ(8,10,REC=1) STRING
      READ(9,10,REC=1) STRING
      READ(10,10,REC=1) STRING
      RETURN
      END
      SUBROUTINE MENU(ACTION)
      INTEGER ACTION
      CALL PRINT('Select one of the following:',28)
      CALL PRINT('01) Input an new article'    ,24)
      CALL PRINT('02) Delete an existing article',30)
      CALL PRINT('03) Search Tree'               ,15)
      CALL PRINT('04) Print Tree on printer'     ,25)
      CALL PRINT('05) Print free disk space'     ,25)
      CALL PRINT('06) Modify Tree structure'     ,25)
      CALL PRINT('07) Create new Master entry'   ,27)
      CALL PRINT('08) Exit Program'              ,16)
      WRITE(1,1000)
 1000 FORMAT ('+ENTER YOUR SELECTION: ')
   10 READ (1,1001) ACTION
 1001 FORMAT (I2)
      IF (ACTION.LT.1) GO TO 10
      IF (ACTION.GT.8) GO TO 10
      RETURN
      END
      SUBROUTINE TYPEIN
      INTEGER FILNAM(5),TEXT(31),ERRCOD,LSTART
      COMMON ERRCOD,LSTART
      DO 10 I=2,101
      READ (9,1000,REC=I) IACNO
 1000 FORMAT (I5)
 2000 FORMAT (' ',I5)
      IF (IACNO.EQ.0) GO TO 10
      IDUMMY=0
      WRITE (9,2000,REC=I) IDUMMY
      GO TO 11
   10 CONTINUE
      READ (9,1000,REC=1) IACNO
      INAC=IACNO+1
      WRITE (9,2000,REC=1) INAC
C     - IACNO IS NUMBER OF RECORD TO INPUT.
   11 WRITE (1,1001)
      READ  (1,1002) IMAXLN
 1001 FORMAT ('+INPUT MAXIMUM LENGTH (GRANS): ')
 1002 FORMAT (I2)
      DO 15 I=1,20
      READ  (7,1000,REC=I) IFREE
      IF (IFREE.GE.IMAXLN) GO TO 16
   15 CONTINUE
      WRITE (1,1003)
 1003 FORMAT ('+NO DISK SPACE AVAILABLE!')
      ERRCOD=1
      RETURN
   16 IDISK=I
      CALL FNAME(IACNO,FILNAM)
      CALL INSDSK(IDISK)
      CALL OPEN(5,FILNAM,64)
      ICOUNT=0
   20 READ (1,1004) TEXT
 1004 FORMAT (31A2)
 2004 FORMAT (' ',31A2)
      IF ((TEXT(1).EQ.'.E').AND.(TEXT(2).EQ.'ND'))GOTO 25
      WRITE(5,2004) TEXT
      ICOUNT=ICOUNT+1
      GO TO 20
   25 ENDFILE 5
      CALL INSDSK(0)
      ICOU2=(ICOUNT-1)/20+1
      IFREE=IFREE-ICOU2
      WRITE(7,2000,REC=IDISK) IFREE
      WRITE(10,1005,REC=IACNO) IDISK,ICOU2
      ERRCOD=0
      LSTART=IACNO
      WRITE (1,2006) IACNO
 2006 FORMAT ('+THIS IS ARTICLE #',I5)
 1005 FORMAT (' ',2I5)
      RETURN
      END
      SUBROUTINE INSDSK(NUM)
      INTEGER NUM
      IF (NUM.EQ.0) GO TO 10
      WRITE (1,1000) NUM
 1000 FORMAT('+PLEASE INSERT DATA DISK NUMBER ',I2)
      CALL WAITKB
      RETURN
   10 CALL PRINT('Please insert MASTER disk',25)
      CALL WAITKB
      RETURN
      END
      SUBROUTINE WAITKB
      CALL PRINT('Press RETURN when ready to continue:',36)
   11 IP=PEEK(14400)-1
      IF (IP) 11,12,11
   12 RETURN
      END
      SUBROUTINE DELART(NUM)
      INTEGER ERRCOD,LSTART
      COMMON ERRCOD,LSTART
      IF (NUM) 10,10,5
    5 READ (9,1000,REC=1) ICUR
      IF (NUM.LT.ICUR) GO TO 20
   10 ERRCOD=1
      CALL PRINT('BAD ARTICLE NUMBER.',19)
      RETURN
   20 DO 25 I=2,101
      READ (9,1000,REC=I) IDEL
 1000 FORMAT (I5)
 2000 FORMAT (' ',I5)
      IF (IDEL.EQ.NUM) GO TO 10
   25 CONTINUE
      DO 30 I=2,101
      READ(9,1000,REC=I) IDEL
      IF (IDEL.EQ.0) GO TO 35
   30 CONTINUE
      CALL PRINT('TOO MANY ARTICLES DELETED!',26)
      ERRCOD=1
      RETURN
   35 WRITE (9,2000,REC=I) NUM
      READ (10,1001,REC=NUM) IDISK,ILEN
 1001 FORMAT (2I5)
 2001 FORMAT (' ',2I5)
      IDUMMY=0
      WRITE (10,2001,REC=NUM) IDUMMY,IDUMMY
      READ (7,1000,REC=IDISK) IFREE
      IFREE=IFREE+ILEN
      WRITE (7,2000,REC=IDISK) IFREE
      ERRCOD=0
      RETURN
      END
      SUBROUTINE FNAME(NUMBER,NAME)
      INTEGER NUMBER,NAME(5),DIGIT(5)
      K=NUMBER
      DO 5 I=1,5
    5 NAME(I)='  '
      DO 10 I=1,5
      J=6-I
      L=K/10
      DIGIT(J)=K-L*10
      K=K/10
   10 CONTINUE
      ENCODE (NAME,100) (DIGIT(I),I=1,5)
  100 FORMAT ('A',5I1)
      RETURN
      END
      SUBROUTINE DELLKS(NUMBER)
      INTEGER NUMLKS,TYPE,ARTNUM,STRING(8)
      NUMLKS=0
      I=0
      J=0
   10 I=I+1
   15 J=J+1
      READ (6,1000,REC=J) TYPE,ARTNUM,STRING
 1000 FORMAT (A2,I5,8A2)
 2000 FORMAT (' ',A2,I5,8A2)
      IF (TYPE.NE.'AR') GO TO 20
      IF (ARTNUM.EQ.NUMBER) GO TO 15
   20 WRITE(6,2000,REC=I) TYPE,ARTNUM,STRING
      IF (TYPE.NE.'EN') GO TO 10
      NUMLKS=J-I
      WRITE (1,1001) NUMLKS
 1001 FORMAT ('+Deleted ',I5,' Links.')
      RETURN
      END
      SUBROUTINE PTREE
      INTEGER INDENT,TYPE,NUM,STRING(8),SPACES(32),
     X        NUM2(5)
      REWIND 6
      INDENT=0
   10 READ (6,1000) TYPE,NUM,STRING
 1000 FORMAT (A2,I5,8A2)
      IF (TYPE.EQ.'EN') GO TO 40
      IF (TYPE.EQ.'IN') GO TO 20
      IF (TYPE.EQ.'OT') GO TO 30
C     - Print Article name,comment #
      CALL DENT(INDENT,SPACES)
      CALL FNUMB(NUM,NUM2)
      WRITE (2,1001) SPACES,(NUM2(I),I=1,3),
     X               (STRING(J),J=1,3)
 1001 FORMAT('+',32A2,3A2,' ( ',3A2,').')
      GO TO 10
   20 INDENT=INDENT+1
      CALL DENT(INDENT,SPACES)
      CALL FNUMB(NUM,NUM2)
      WRITE (2,1002) SPACES,STRING,(NUM2(I),I=1,3)
 1002 FORMAT('+',32A2,8A2,' (',3A2,' ).')
      GO TO 10
   30 INDENT=INDENT-1
      GO TO 10
   40 WRITE (2,1003)
 1003 FORMAT('+ ')
      RETURN
      END
      SUBROUTINE FRESPC
      INTEGER FREE1,FREE2
      REWIND 7
      CALL PRINT('DISK FREE SPACE (GRANS):',24)
      DO 10 I=1,19,2
      READ (7,1000) FREE1
      READ (7,1000) FREE2
 1000 FORMAT (I5)
      J=I+1
      WRITE (1,1001) I,FREE1,J,FREE2
 1001 FORMAT ('+DISK ',I2,', FREE: ',I2,3X,'DISK ',
     X       I2,', FREE: ',I2,'.')
   10 CONTINUE
      RETURN
      END
      SUBROUTINE FINISH
      CALL PRINT('Closing files',13)
      ENDFILE 6
      ENDFILE 7
      ENDFILE 8
      ENDFILE 9
      ENDFILE 10
      RETURN
      END
      SUBROUTINE DENT(INDENT,SPACES)
      INTEGER INDENT,SPACES(32)
      DO 10 I=1,32
      SPACES(I)=0
   10 CONTINUE
      IF (INDENT.EQ.0) GO TO 30
      J=INDENT*2
      DO 20 I=1,J
      SPACES(I)='  '
   20 CONTINUE
   30 RETURN
      END
      SUBROUTINE FNUMB(NUMBER,NAME)
      INTEGER NUMBER,NAME(5),DIGIT(5)
      DO 5 I=1,5
      NAME(I)='  '
    5 CONTINUE
      K=NUMBER
      DO 10 I=1,5
      J=6-I
      L=K/10
      DIGIT(J)=K-L*10
      K=K/10
   10 CONTINUE
      ENCODE (NAME,100) (DIGIT(I),I=1,5)
  100 FORMAT (' ',5I1)
      RETURN
      END
      SUBROUTINE PRTART(NUMBER)
      INTEGER ERRCOD,TEXT,NUMBER,STRING(16),STR2(31),
     X        FILNAM(5),LSTART
      COMMON ERRCOD,LSTART
      IF (NUMBER.EQ.0) NUMBER=LSTART
      IF (NUMBER.LT.1) GO TO 100
      READ (9,1003,REC=1) IMAXNO
 1003 FORMAT (I5)
      IF (IMAXNO.LE.NUMBER) GO TO 100
      DO 10 I=2,101
      READ (9,1003,REC=I) IDELNO
      IF (IDELNO.EQ.NUMBER) GO TO 100
   10 CONTINUE
      WRITE (1,2000) NUMBER
 2000 FORMAT('+PRINTING ARTICLE # ',I5,'.')
      WRITE (1,2001)
      READ  (1,1002) TEXT
 2001 FORMAT('+OUTPUT TO <SC>REEN OR <PR>INTER: ')
 1002 FORMAT (A2)
      IUNIT=1
      IF (TEXT.EQ.'PR') IUNIT=2
      READ (10,1004,REC=NUMBER) IDSK,ILNG
 1004 FORMAT (2I5)
      IF (IUNIT.EQ.1) CALL CLS
      IPAT=0
   20 CALL INSDSK(IDSK)
      CALL FNAME(NUMBER,FILNAM)
      CALL OPEN(5,FILNAM,64)
   30 READ (5,1006,END=40) STR2
 1006 FORMAT (31A2)
 2006 FORMAT ('+',31A2)
      WRITE (IUNIT,2006) STR2
      IPAT=IPAT+1
      IF (IPAT.EQ.16) IPAT=0
      IF (IUNIT.EQ.2) GO TO 30
      IF (IPAT.NE.0) GO TO 30
   35 IPK=PEEK(14400)
      IF (IPK.EQ.128) GO TO 30
      GO TO 35
   40 ENDFILE 5
      WRITE (IUNIT,2007)
 2007 FORMAT ('+ ')
      CALL INSDSK(0)
      RETURN
  100 ERRCOD=1
      CALL PRINT('BAD ARTICLE NUMBER.',19)
      RETURN
      END
      SUBROUTINE CLS
      INTEGER CHARS
      CHARS=X'1F1C'
      CALL PRINT(CHARS,2)
      CALL POKE(X'4020',0)
      CALL POKE(X'4021',60)
      RETURN
      END
      SUBROUTINE CRMAST(SNAME)
      INTEGER ERRCOD,LSTART,LEVEL,SNAME(8),TYPE,COMM,
     X  STRING(8),RECORD
      COMMON ERRCOD,LSTART
      REWIND 6
      LEVEL=0
      RECORD=0
   10 RECORD=RECORD+1
      READ (6,1000,REC=RECORD) TYPE,COMM,STRING
 1000 FORMAT (A2,I5,8A2)
      IF (TYPE.EQ.'AR') GO TO 10
      IF (TYPE.EQ.'IN') GO TO 20
      IF (TYPE.EQ.'EN') GO TO 30
      LEVEL=LEVEL-1
      GO TO 10
   20 LEVEL=LEVEL+1
      IF (LEVEL.NE.1) GO TO 10
      DO 25 I=1,8
      IF (SNAME(I).NE.STRING(I)) GO TO 10
   25 CONTINUE
      ERRCOD=1
      CALL PRINT('NAME ALREADY EXISTS!',20)
      RETURN
   30 WRITE (6,2001,REC=RECORD) SNAME
      I=RECORD+1
      I2=I+1
 2001 FORMAT ('+IN00000',8A2)
      WRITE (6,2002,REC=I)
      WRITE (6,2003,REC=I2)
 2002 FORMAT ('+OT',21X)
 2003 FORMAT ('+EN',21X)
      RETURN
      END
      SUBROUTINE SEARCH
      INTEGER LEVEL,NAME(8),RECNO,TYPE,COMM,ACTION,
     X  ERRCOD,LSTART
      COMMON ERRCOD,LSTART
      REWIND 6
      RECNO=1
      LEVEL=1
   10 READ (6,1000,REC=RECNO) TYPE,COMM,NAME
 1000 FORMAT (A2,I5,8A2)
      WRITE (1,2001) LEVEL,NAME
 2001 FORMAT ('+LEVEL ',I2,', NAME: ',8A2)
      CALL PFILES(RECNO)
   20 WRITE (1,2002)
      READ (1,1003) ACTION
 2002 FORMAT ('+INPUT COMMAND? ')
 1003 FORMAT (A2)
      IF (ACTION.EQ.'EN') GO TO 40
      IF (ACTION.EQ.'VU') GO TO 30
      CALL MOVE(ACTION,LEVEL,RECNO)
      GO TO 10
   30 WRITE (1,2004)
      READ (1,1005) COMM
 2004 FORMAT ('+VIEW WHICH ARTICLE? ')
 1005 FORMAT (I5)
      CALL PRTART(COMM)
      LSTART=COMM
      IF (ERRCOD) 20,10,20
   40 RETURN
      END
      SUBROUTINE MOVE(ACTION,OLEVEL,ORECNO)
      INTEGER ACTION,OLEVEL,ORECNO,LEVEL,RECNO,TYPE,
     X  COMM,NAME(8)
      LEVEL=OLEVEL
      RECNO=ORECNO
      IF (ACTION.EQ.'UP') GO TO 10
      IF (ACTION.EQ.'DO') GO TO 30
      IF (ACTION.EQ.'IN') GO TO 40
      IF (ACTION.EQ.'OU') GO TO 50
      RETURN
   10 IF (RECNO.NE.1) GO TO 20
   11 CALL PRINT('NO PREVIOUS ENTRIES ON THIS LEVEL',33)
      RETURN
   12 CALL PRINT('NO LATER ENTRIES ON THIS LEVEL',30)
      RETURN
   13 CALL PRINT('NO OUTER LEVEL',14)
      RETURN
   14 CALL PRINT('NO INNER LEVEL',14)
      RETURN
   20 ILEV=0
      IREC2=RECNO
   22 IREC2=IREC2-1
      READ (6,1000,REC=IREC2) TYPE,COMM,NAME
 1000 FORMAT (A2,I5,8A2)
      IF (TYPE.EQ.'AR') GO TO 22
      IF (TYPE.EQ.'OT') GO TO 27
      ILEV=ILEV-1
      IF (ILEV) 11,25,22
   25 ORECNO=IREC2
      RETURN
   27 ILEV=ILEV+1
      GO TO 22
   30 ILEV=0
      IREC2=RECNO
   32 IREC2=IREC2+1
      READ (6,1000,REC=IREC2) TYPE,COMM,NAME
      IF (TYPE.EQ.'AR') GO TO 32
      IF (TYPE.EQ.'OT') GO TO 35
      IF (TYPE.EQ.'EN') GO TO 12
      ILEV=ILEV+1
      IF (ILEV.NE.0) GO TO 32
      ORECNO=IREC2
      RETURN
   35 ILEV=ILEV-1
      IF (ILEV.NE.-2) GO TO 32
      GO TO 12
   40 IREC2=RECNO
   42 IREC2=IREC2+1
      READ (6,1000,REC=IREC2) TYPE,COMM,NAME
      IF (TYPE.EQ.'AR') GO TO 42
      IF (TYPE.NE.'IN') GO TO 14
      ORECNO=IREC2
      OLEVEL=OLEVEL+1
      RETURN
   50 ILEV=1
      IREC2=RECNO
   52 IREC2=IREC2-1
      IF (IREC2.EQ.0) GO TO 13
      READ (6,1000,REC=IREC2) TYPE,COMM,NAME
      IF (TYPE.EQ.'AR') GO TO 52
      IF (TYPE.EQ.'OT') GO TO 55
      ILEV=ILEV-1
      IF (ILEV.NE.0) GO TO 52
      OLEVEL=OLEVEL-1
      ORECNO=IREC2
      RETURN
   55 ILEV=ILEV+1
      GO TO 52
      END
      SUBROUTINE PFILES(RECNO)
      INTEGER RECNO,IREC2,LEVEL,NAME(8),TYPE,COMM
      IREC2=RECNO
      LEVEL=0
   10 IREC2=IREC2+1
      READ (6,1000,REC=IREC2) TYPE,COMM,NAME
 1000 FORMAT (A2,I5,8A2)
      IF (TYPE.EQ.'EN') GO TO 40
      IF (TYPE.EQ.'IN') GO TO 20
      IF (TYPE.EQ.'OT') GO TO 30
      IF (LEVEL.NE.0) GO TO 10
      WRITE (1,2001) COMM
 2001 FORMAT ('+',5X,I5)
      GO TO 10
   20 LEVEL=LEVEL+1
      GO TO 10
   30 LEVEL=LEVEL-1
      IF (LEVEL) 40,10,10
   40 RETURN
      END
      SUBROUTINE WALK
      INTEGER ERRCOD,LSTART,TYPE,COMM,NAME(8),ACTION,
     X  NRECS,RECNO
      COMMON ERRCOD,LSTART
      RECNO=1
      LEVEL=1
      CALL EOF6(NRECS)
   10 READ (6,1000,REC=RECNO) TYPE,COMM,NAME
 1000 FORMAT (A2,I5,8A2)
      WRITE (1,2001) LEVEL,NAME
      CALL PFILES(RECNO)
 2001 FORMAT ('+LEVEL ',I2,', NAME: ',8A2)
   20 WRITE (1,2002)
      READ (1,1003) ACTION
 2002 FORMAT ('+ENTER COMMAND: ')
 1003 FORMAT (A2)
      IF (ACTION.EQ.'QU') GO TO 70
      IF (ACTION.EQ.'CS') GO TO 30
      IF (ACTION.EQ.'DS') GO TO 40
      IF (ACTION.EQ.'CF') GO TO 50
      IF (ACTION.EQ.'DF') GO TO 60
      CALL MOVE(ACTION,LEVEL,RECNO)
      GO TO 10
   30 WRITE (1,2004)
      READ (1,1005) NAME
 2004 FORMAT ('+ENTER NAME OF NEW SUB-ENTRY: ')
 1005 FORMAT (8A2)
      CALL CRSUB(NAME,RECNO,NRECS)
      GO TO 20
   40 IF (LEVEL.EQ.1) GO TO 42
      CALL DELSUB(LEVEL,RECNO,NRECS)
      GO TO 10
   42 CALL PRINT('NO WAY JOSE!',12)
      GO TO 20
   50 WRITE (1,2006)
      READ (1,1007) COMM
 2006 FORMAT ('+WHICH ARTICLE #? ')
 1007 FORMAT (I5)
      IF (COMM.LT.1) GO TO 50
      CALL INSLK(COMM,RECNO,NRECS)
      GO TO 10
   60 WRITE (1,2008)
      READ (1,1009) COMM
 2008 FORMAT ('+DELETE ENTRY FOR WHICH ARTICLE? ')
 1009 FORMAT (I5)
      IF (COMM.LT.1) GO TO 60
      CALL DELLK(COMM,RECNO,NRECS)
      GO TO 10
   70 RETURN
      END
      SUBROUTINE EOF6(REC)
      INTEGER TYPE,COMM,NAME(8),REC
      REC=0
   10 REC=REC+1
      READ (6,1000,REC=REC) TYPE,COMM,NAME
 1000 FORMAT (A2,I5,8A2)
      IF (TYPE.NE.'EN') GO TO 10
      RETURN
      END
      SUBROUTINE CRSUB(NAME,RECNO,NRECS)
      INTEGER RECNO,NRECS,NAME(8),TYPE,COMM,NA(8)
      ILP=NRECS-RECNO
      NRECS=NRECS+2
      DO 10 I=1,ILP
      I2=NRECS-I-1
      I3=I2+2
      READ (6,1000,REC=I2) TYPE,COMM,NA
      WRITE (6,2000,REC=I3) TYPE,COMM,NA
 1000 FORMAT (A2,I5,8A2)
 2000 FORMAT ('+',A2,I5,8A2)
   10 CONTINUE
      I4=RECNO+1
      I5=RECNO+2
      WRITE (6,2001,REC=I4) NAME
      WRITE (6,2002,REC=I5)
 2001 FORMAT ('+IN00000',8A2)
 2002 FORMAT ('+OT',21X)
      RETURN
      END
      SUBROUTINE INSLK(NUMBER,RECNO,NRECS)
      INTEGER NUMBER,RECNO,NRECS,TYPE,COMM,NAME(8)
      ILP=NRECS-RECNO
      NRECS=NRECS+1
      DO 10 I=1,ILP
      I2=NRECS-I
      I3=I2+1
      READ (6,1000,REC=I2) TYPE,COMM,NAME
      WRITE(6,2000,REC=I3) TYPE,COMM,NAME
 1000 FORMAT (A2,I5,8A2)
 2000 FORMAT ('+',A2,I5,8A2)
   10 CONTINUE
      I4=RECNO+1
      WRITE (6,2001,REC=I4) NUMBER
 2001 FORMAT ('+AR',I5,'00000',11X)
      RETURN
      END
      SUBROUTINE DELLK(NUMBER,RECNO,NRECS)
      INTEGER NUMBER,RECNO,NRECS,TYPE,COMM,NAME(8),
     X  LEVEL,IREC2
      LEVEL=0
      IREC2=RECNO
   10 IREC2=IREC2+1
      READ (6,1000,REC=IREC2) TYPE,COMM,NAME
 1000 FORMAT (A2,I5,8A2)
 2000 FORMAT ('+',A2,I5,8A2)
      IF (TYPE.EQ.'EN') GO TO 30
      IF (TYPE.EQ.'OT') GO TO 40
      IF (TYPE.EQ.'AR') GO TO 20
      LEVEL=LEVEL+1
      GO TO 10
   20 IF (LEVEL.NE.0) GO TO 10
      IF (COMM.NE.NUMBER) GO TO 10
      I2=NRECS-IREC2
      DO 25 I=1,I2
      I3=IREC2+I
      I4=I3-1
      READ (6,1000,REC=I3) TYPE,COMM,NAME
      WRITE (6,2000,REC=I4) TYPE,COMM,NAME
   25 CONTINUE
   30 RETURN
   40 LEVEL=LEVEL-1
      IF (LEVEL) 30,10,10
      END
