;ZorkA/SRC: Zork 1 for TRS-80 I, File 1.
;Last updated 15-Feb-86.
;
;
H4301	XOR	A
	LD	(H42EE),A	;Track 0
	CALL	OPEN_FILE	;Open data file
	JP	H437F		;bypass check.
;
*GET	ZORKDOS			;Dos interface.
*GET	ZORKFIX			;Fix for crashes.
;
H4323	LD	HL,(H42F3)	;Set load address
	LD	(H42F0),HL
	CALL	H434C		;Write sector
	JP	NZ,H4340	;if error
	LD	HL,(H589E)
	INC	H
	LD	(H42F0),HL
	CALL	H4293		;verify read
	JP	NZ,H4340	;if error
	CALL	H436D		;compare.
	RET	Z		;if ok
H4340	LD	A,(3840H)	;ret if break
	AND	4
	RET	NZ
	CALL	H42BD		;restore head
	JP	H4323
H434C	CALL	H4262
	LD	(HL),0AAH
	PUSH	BC
	POP	BC
	PUSH	BC
	POP	BC
	JP	H435D
H4358	LD	A,(HL)
	RRCA
	JP	NC,H4369
H435D	LD	A,(HL)
	AND	2
	JP	Z,H4358
	LD	A,(BC)
	LD	(DE),A
	INC	BC
	JP	H435D
H4369	LD	A,(HL)
	AND	1CH
	RET
H436D	LD	HL,(H42F0)
	EX	DE,HL
	LD	HL,(H42F3)
H4374	LD	A,(DE)
	CP	(HL)
	RET	NZ
	INC	DE
	INC	HL
	LD	A,L
	OR	A
	JP	NZ,H4374
	RET
;
H437F	LD	SP,STACK	;Game start
	XOR	A
	LD	(H5899),A
	LD	(H58A0),A
	LD	(H5968),A
	LD	A,1
	LD	(H5879),A
	LD	HL,H41FE
	LD	(H587A),HL
	LD	DE,H58A7
	LD	BC,4000H
H439D	XOR	A		;Make table
	LD	(DE),A
	LD	HL,0040H
	ADD	HL,DE
	LD	(HL),C
	INC	(HL)
	LD	HL,0080H
	ADD	HL,DE
	LD	(HL),C
	DEC	(HL)
	INC	C
	INC	DE
	DEC	B
	JP	NZ,H439D
	LD	HL,003FH
	ADD	HL,DE
	LD	(HL),0FFH
	LD	A,'?'
	LD	(H5969),A
	LD	HL,H5A77
	LD	DE,00FFH
	ADD	HL,DE
	LD	L,0
	LD	(H58A4),HL
	CALL	H57D2		;Check screen type.
	LD	HL,(H58A4)
	XOR	A
	CALL	GETBLOCK	;Read dual sector #0.
	LD	HL,(H58A4)
	LD	DE,0004H
	ADD	HL,DE
	LD	D,(HL)
	INC	HL
	LD	E,(HL)		;Get word
	LD	HL,0200H
	ADD	HL,DE
	LD	A,H
	AND	0FEH
	LD	H,A
	LD	L,0
	DEC	HL
	EX	DE,HL
	LD	BC,0004H
	LD	HL,(H58A4)
	ADD	HL,BC
	LD	(HL),D
	INC	HL
	LD	(HL),E
	LD	HL,(H58A4)
	PUSH	DE
	ADD	HL,DE
	EX	DE,HL
	CALL	GETHIMEM
	EX	DE,HL
	CALL	H4F48
	POP	DE
	CALL	C,CRASH
	LD	A,D
	RRCA
	AND	7FH
	LD	D,A
	INC	A
	LD	(H58A6),A
	LD	HL,(H58A4)
	LD	BC,0200H
	LD	E,0
H4414	LD	A,D
	OR	A
	JP	Z,H4429
	DEC	D
	ADD	HL,BC
	INC	E
	LD	A,E
	PUSH	BC
	PUSH	DE
	PUSH	HL
	CALL	GETBLOCK
	POP	HL
	POP	DE
	POP	BC
	JP	H4414
H4429	LD	HL,(H58A4)
	EX	DE,HL
	LD	HL,0001H
	ADD	HL,DE
	LD	A,(HL)
	AND	1
	CALL	NZ,CRASH
	LD	HL,0007H
	ADD	HL,DE
	LD	A,(HL)
	LD	(H5873),A
	DEC	HL
	LD	A,(HL)
	AND	1
	LD	(H5874),A
	LD	A,(HL)
	RRCA
	AND	7FH
	LD	(H5872),A
	LD	HL,000CH
	ADD	HL,DE
	PUSH	DE
	LD	D,(HL)
	INC	HL
	LD	E,(HL)
	EX	DE,HL
	POP	DE
	ADD	HL,DE
	LD	(H5893),HL
	LD	HL,0004H
	ADD	HL,DE
	PUSH	DE
	LD	D,(HL)
	INC	HL
	LD	E,(HL)
	POP	HL
	ADD	HL,DE
	INC	HL
	LD	(H58A2),HL
	DEC	HL
	EX	DE,HL
	CALL	GETHIMEM
	LD	A,H
	SUB	D
	RRCA
	AND	'?'
	CALL	Z,CRASH
	LD	(H5967),A
	DEC	A
	LD	(H5969),A
	LD	HL,H58E7
	CALL	ADDHLA
	LD	(HL),0FFH
	LD	B,5
	LD	HL,0FFFFH
	LD	(H5875),HL
	LD	(H5877),HL
H4490	CALL	H4E11
	DEC	B
	JP	NZ,H4490
	XOR	A
	LD	(SCRIPT_1),A
	JP	H449E
H449E	XOR	A
	LD	(H5891),A
	CALL	H4F7D
	LD	(H5892),A
	CP	80H
	JP	C,H4544
	CP	0B0H
	JP	C,H451B
	CP	0C0H
	JP	C,H450E
	CALL	H4F7D
	LD	DE,H5889
	LD	B,4
	LD	C,A
H44C0	PUSH	BC
	PUSH	DE
	LD	A,C
	AND	0C0H
	CALL	Z,H457B
	CP	80H
	CALL	Z,H45A6
	CP	'@'
	CALL	Z,H4572
	POP	DE
	POP	BC
	CP	0C0H
	JP	Z,H44EB
	EX	DE,HL
	LD	(HL),E
	INC	HL
	LD	(HL),D
	INC	HL
	EX	DE,HL
	LD	HL,H5891
	INC	(HL)
	LD	A,C
	RLCA
	RLCA
	LD	C,A
	DEC	B
	JP	NZ,H44C0
H44EB	LD	HL,H46F5
	LD	A,(H5892)
	CP	0E0H
	JP	C,H4565
	SUB	0E0H
	CP	0AH
	JP	NC,H47E8
H44FD	ADD	A,A
	LD	C,A
	LD	B,0
	ADD	HL,BC
	LD	E,(HL)
	INC	HL
	LD	D,(HL)
	LD	HL,(H5889)
	EX	DE,HL
	LD	A,(H5891)
	LD	B,A
	JP	(HL)
H450E	SUB	0B0H
	CP	0CH
	JP	NC,H47E8
	LD	HL,H468B
	JP	H44FD
H451B	AND	'0'
	CALL	Z,H457B
	CP	10H
	CALL	Z,H4572
	CP	' '
	CALL	Z,H45A6
	LD	A,1
	LD	(H5891),A
	LD	(H5889),HL
	LD	A,(H5892)
	AND	0CFH
	SUB	80H
	CP	10H
	JP	NC,H47E8
	LD	HL,H46A3
	JP	H44FD
H4544	AND	'@'
	CALL	NZ,H45A6
	CALL	Z,H4572
	LD	(H5889),HL
	LD	A,(H5892)
	AND	' '
	CALL	NZ,H45A6
	CALL	Z,H4572
	LD	(H588B),HL
	LD	A,2
	LD	(H5891),A
	LD	A,(H5892)
H4565	AND	1FH
	CP	19H
	JP	NC,H47E8
	LD	HL,H46C3
	JP	H44FD
H4572	PUSH	AF
	CALL	H4F7D
	LD	L,A
	LD	H,0
	POP	AF
	RET
H457B	PUSH	AF
	CALL	H4F7D
	LD	H,A
	PUSH	HL
	CALL	H4F7D
	POP	HL
	LD	L,A
	POP	AF
	RET
H4588	PUSH	AF
	OR	A
	JP	Z,H4597
	JP	H45AE
H4590	OR	A
	JP	Z,H459E
	JP	H45E2
H4597	POP	AF
	CALL	APOP
	JP	APUSH
H459E	PUSH	HL
	CALL	APOP
	POP	HL
	JP	APUSH
H45A6	PUSH	AF
	CALL	H4F7D
	OR	A
	JP	Z,H45CE
H45AE	CP	10H
	JP	NC,H45C2
	DEC	A
	ADD	A,A
	LD	E,A
	LD	D,0
	LD	HL,H5854
H45BB	ADD	HL,DE
	LD	D,(HL)
	INC	HL
	LD	E,(HL)
	EX	DE,HL
	POP	AF
	RET
H45C2	SUB	10H
	LD	E,A
	LD	D,0
	LD	HL,(H5893)
	ADD	HL,DE
	JP	H45BB
H45CE	CALL	APOP
	POP	AF
	RET
H45D3	XOR	A
H45D4	LD	L,A
	LD	H,0
H45D7	CALL	H45DD
	JP	H449E
H45DD	PUSH	HL
	CALL	H4F7D
	POP	HL
H45E2	OR	A
	JP	Z,APUSH
	EX	DE,HL
	CP	10H
	JP	NC,H45F9
	DEC	A
	ADD	A,A
	LD	C,A
	LD	B,0
	LD	HL,H5854
H45F4	ADD	HL,BC
	LD	(HL),D
	INC	HL
	LD	(HL),E
	RET
H45F9	SUB	10H
	LD	C,A
	LD	B,0
	LD	HL,(H5893)
	ADD	HL,BC
	JP	H45F4
ENTRY	CALL	H4F7D
	OR	A
	JP	M,H461E
	JP	H4616
H460F	CALL	H4F7D
	OR	A
	JP	P,H461E
H4616	AND	'@'
	CALL	Z,H4F7D
	JP	H449E
H461E	LD	B,A
	AND	'@'
	JP	Z,H462D
	LD	A,B
	AND	'?'
	LD	C,A
	LD	B,0
	JP	H4641
H462D	LD	A,B
	AND	'?'
	LD	B,A
	PUSH	BC
	CALL	H4F7D
	POP	BC
	LD	C,A
	LD	A,B
	AND	' '
	JP	Z,H4641
	LD	A,B
	OR	0C0H
	LD	B,A
H4641	LD	A,B
	OR	C
	JP	Z,H4712
	DEC	BC
	LD	A,B
	OR	C
	JP	Z,H4709
H464C	DEC	BC
	LD	H,B
	LD	L,C
	LD	(H5895),HL
	LD	HL,(H5873)
	LD	E,C
	LD	A,B
	AND	1
	LD	D,A
	LD	A,B
	RLCA
	LD	A,B
	RRA
	LD	B,A
	ADD	HL,DE
	LD	A,H
	AND	2
	JP	Z,H4669
	DEC	H
	DEC	H
	INC	B
H4669	LD	(H5873),HL
	LD	HL,H5872
	LD	A,B
	OR	A
	JP	Z,H467D
	ADD	A,(HL)
	LD	(HL),A
	XOR	A
	LD	(H5899),A
	JP	H449E
H467D	LD	HL,(H5897)
	EX	DE,HL
	LD	HL,(H5895)
	ADD	HL,DE
	LD	(H5897),HL
	JP	H449E
H468B	DEFW	H4709
	DEFW	H4712
	DEFW	H4718
	DEFW	H474A
	DEFW	H4753
	DEFW	ENTRY	;was H5620 SAVE GAME.
	DEFW	ENTRY	;was H56F9 LOAD GAME.
	DEFW	H574A
	DEFW	H4756
	DEFW	H475F
	DEFW	H5747
	DEFW	H4765
H46A3	DEFW	H476B
	DEFW	H4776
	DEFW	H4782
	DEFW	H479C
	DEFW	H47AC
	DEFW	H47BC
	DEFW	H47C2
	DEFW	H47DF
	DEFW	H47E8
	DEFW	H47EB
	DEFW	H4841
	DEFW	H485C
	DEFW	H48A7
	DEFW	H48B0
	DEFW	H48BC
	DEFW	H48C5
H46C3	DEFW	H47E8
	DEFW	H4AED
	DEFW	H48D1
	DEFW	H48DE
	DEFW	H48EA
	DEFW	H48F5
	DEFW	H4905
	DEFW	H4919
	DEFW	H492B
	DEFW	H4937
	DEFW	H4943
	DEFW	H4952
	DEFW	H495F
	DEFW	H496E
	DEFW	H497A
	DEFW	H49A6
	DEFW	H49BB
	DEFW	H49CE
	DEFW	H4A1A
	DEFW	H4A3F
	DEFW	H4A69
	DEFW	H4A70
	DEFW	H4A7C
	DEFW	H4AA8
	DEFW	H4ADF
H46F5	DEFW	H4B1A
	DEFW	H4BA6
	DEFW	H4BBF
	DEFW	H4BD3
	DEFW	H4C05
	DEFW	H4DA7
	DEFW	H4DB1
	DEFW	H4DF0
	DEFW	H4DFF
	DEFW	H4E08
H4709	LD	HL,0001H
H470C	LD	(H5889),HL
	JP	H485C
H4712	LD	HL,0000H
	JP	H470C
H4718	CALL	H471E
	JP	H449E
H471E	LD	HL,(H5873)
	LD	(H589C),HL
	LD	A,(H5872)
	LD	(H589B),A
	XOR	A
	LD	(H58A0),A
	CALL	H513F
	LD	HL,(H589C)
	LD	(H5873),HL
	LD	A,(H589B)
	LD	(H5872),A
	LD	A,(H58A0)
	LD	(H5899),A
	LD	HL,(H589E)
	LD	(H5897),HL
	RET
H474A	CALL	H471E
	CALL	H555F
	JP	H4709
H4753	JP	H449E
H4756	CALL	APOP
	LD	(H5889),HL
	JP	H485C
H475F	CALL	APOP
	JP	H449E
H4765	CALL	H555F
	JP	H449E
H476B	LD	HL,(H5889)
	LD	A,H
	OR	L
	JP	Z,ENTRY
	JP	H460F
H4776	LD	A,(H5889)
	CALL	H4F17
	LD	DE,0005H
	JP	H478B
H4782	LD	A,(H5889)
	CALL	H4F17
	LD	DE,0006H
H478B	ADD	HL,DE
	LD	A,(HL)
	PUSH	AF
	LD	L,A
	LD	H,0
	CALL	H45DD
	POP	AF
	OR	A
	JP	NZ,ENTRY
	JP	H460F
H479C	LD	A,(H5889)
	CALL	H4F17
	LD	DE,0004H
	ADD	HL,DE
	LD	L,(HL)
	LD	H,0
	JP	H45D7
H47AC	LD	HL,(H5889)
	EX	DE,HL
	LD	HL,(H58A4)
	ADD	HL,DE
	DEC	HL
	CALL	H4F08
	INC	A
	JP	H45D4
H47BC	CALL	H47C8
	JP	H449E
H47C2	CALL	H47D5
	JP	H449E
H47C8	LD	A,(H5889)
	CALL	H4588
	INC	HL
H47CF	PUSH	HL
	CALL	H4590
	POP	HL
	RET
H47D5	LD	A,(H5889)
	CALL	H4588
	DEC	HL
	JP	H47CF
H47DF	LD	HL,(H5889)
	CALL	H5007
	JP	H48B6
H47E8	JP	H449E
H47EB	CALL	H47F1
	JP	H449E
H47F1	LD	A,(H5889)
	LD	B,A
	CALL	H4F17
	EX	DE,HL
	LD	HL,0004H
	ADD	HL,DE
	LD	A,(HL)
	OR	A
	RET	Z
	PUSH	DE
	CALL	H4F17
	LD	DE,0006H
	EX	DE,HL
	ADD	HL,DE
	LD	C,(HL)
	LD	A,B
	CP	C
	JP	NZ,H481E
	POP	HL
	PUSH	HL
	LD	BC,0005H
	ADD	HL,BC
	LD	A,(HL)
	LD	HL,0006H
	ADD	HL,DE
	LD	(HL),A
	JP	H4836
H481E	LD	A,C
	CALL	H4F17
	LD	DE,0005H
	ADD	HL,DE
	LD	D,H
	LD	E,L
	LD	C,(HL)
	LD	A,B
	CP	C
	JP	NZ,H481E
	LD	BC,0005H
	POP	HL
	PUSH	HL
	ADD	HL,BC
	LD	A,(HL)
	LD	(DE),A
H4836	POP	HL
	LD	DE,0004H
	ADD	HL,DE
	LD	(HL),0
	INC	HL
	LD	(HL),0
	RET
H4841	LD	A,(H5889)
	CALL	H484A
	JP	H449E
H484A	CALL	H4F17
	LD	DE,0007H
	ADD	HL,DE
	LD	D,(HL)
	INC	HL
	LD	E,(HL)
	EX	DE,HL
	INC	HL
	CALL	H5007
	JP	H513F
H485C	LD	HL,(H587C)
	LD	(H587A),HL
	LD	A,(H587E)
	LD	(H5879),A
	CALL	APOP
	LD	A,L
	LD	(H5872),A
	LD	B,H
	LD	A,H
	ADD	A,A
	JP	Z,H488A
	LD	HL,CURSOR
	CALL	ADDHLA
H487B	EX	DE,HL
	CALL	APOP
	EX	DE,HL
	LD	(HL),D
	INC	HL
	LD	(HL),E
	DEC	HL
	DEC	HL
	DEC	HL
	DEC	B
	JP	NZ,H487B
H488A	CALL	APOP
	LD	(H5873),HL
	CALL	APOP
	LD	(H587C),HL
	CALL	APOP
	LD	A,L
	LD	(H587E),A
	XOR	A
	LD	(H5899),A
	LD	HL,(H5889)
	JP	H45D7
H48A7	LD	HL,(H5889)
	LD	B,H
	LD	C,L
	DEC	BC
	JP	H464C
H48B0	LD	HL,(H5889)
	CALL	H5019
H48B6	CALL	H513F
	JP	H449E
H48BC	LD	A,(H5889)
	CALL	H4588
	JP	H45D7
H48C5	LD	HL,(H5889)
	LD	A,H
	CPL
	LD	H,A
	LD	A,L
	CPL
	LD	L,A
	JP	H45D7
H48D1	CALL	H4F38
	EX	DE,HL
	CALL	H4F40
	JP	NC,ENTRY
	JP	H460F
H48DE	CALL	H4F38
	CALL	H4F40
	JP	NC,ENTRY
	JP	H460F
H48EA	CALL	H47D5
	EX	DE,HL
	LD	HL,(H588B)
	EX	DE,HL
	JP	H48FC
H48F5	CALL	H47C8
	EX	DE,HL
	LD	HL,(H588B)
H48FC	CALL	H4F40
	JP	NC,ENTRY
	JP	H460F
H4905	LD	A,(H5889)
	CALL	H4F17
	LD	DE,0004H
	ADD	HL,DE
	LD	A,(H588B)
	CP	(HL)
	JP	Z,ENTRY
	JP	H460F
H4919	CALL	H4F38
	LD	A,H
	AND	D
	LD	D,A
	LD	A,L
	AND	E
	LD	E,A
	CALL	H4F48
	JP	Z,ENTRY
	JP	H460F
H492B	CALL	H4F38
	LD	A,D
	OR	H
	LD	H,A
	LD	A,E
	OR	L
	LD	L,A
	JP	H45D7
H4937	CALL	H4F38
	LD	A,H
	AND	D
	LD	H,A
	LD	A,L
	AND	E
	LD	L,A
	JP	H45D7
H4943	CALL	H4EC3
	LD	A,D
	AND	B
	LD	D,A
	LD	A,E
	AND	C
	OR	D
	JP	NZ,ENTRY
	JP	H460F
H4952	CALL	H4EC3
	LD	A,D
	OR	B
	LD	(HL),A
	INC	HL
	LD	A,E
	OR	C
	LD	(HL),A
	JP	H449E
H495F	CALL	H4EC3
	LD	A,B
	CPL
	AND	D
	LD	(HL),A
	INC	HL
	LD	A,C
	CPL
	AND	E
	LD	(HL),A
	JP	H449E
H496E	LD	A,(H5889)
	LD	HL,(H588B)
H4974	CALL	H4590
	JP	H449E
H497A	CALL	H47F1
	LD	A,(H5889)
	CALL	H4F17
	PUSH	HL
	LD	DE,0004H
	ADD	HL,DE
	LD	A,(H588B)
	LD	(HL),A
	CALL	H4F17
	LD	DE,0006H
	ADD	HL,DE
	LD	B,(HL)
	LD	A,(H5889)
	LD	(HL),A
	POP	HL
	LD	A,B
	OR	A
	JP	Z,H449E
	LD	DE,0005H
	ADD	HL,DE
	LD	(HL),A
	JP	H449E
H49A6	LD	HL,(H588B)
	ADD	HL,HL
	EX	DE,HL
	LD	HL,(H5889)
	ADD	HL,DE
	EX	DE,HL
	LD	HL,(H58A4)
	ADD	HL,DE
	LD	D,(HL)
	INC	HL
	LD	E,(HL)
	EX	DE,HL
	JP	H45D7
H49BB	LD	HL,(H588B)
	EX	DE,HL
	LD	HL,(H5889)
	ADD	HL,DE
	EX	DE,HL
	LD	HL,(H58A4)
	ADD	HL,DE
	LD	L,(HL)
	LD	H,0
	JP	H45D7
H49CE	CALL	H4EED
H49D1	CALL	H4F04
	LD	B,A
	LD	A,(H588B)
	CP	B
	JP	Z,H4A02
	JP	NC,H49E5
	CALL	H4F0F
	JP	H49D1
H49E5	LD	HL,(H58A4)
	LD	DE,000AH
	ADD	HL,DE
	LD	D,(HL)
	INC	HL
	LD	E,(HL)
	LD	HL,(H58A4)
	ADD	HL,DE
	LD	A,(H588B)
	ADD	A,A
	CALL	ADDHLA
	DEC	HL
	LD	E,(HL)
	DEC	HL
	LD	D,(HL)
	EX	DE,HL
	JP	H45D7
H4A02	CALL	H4F08
